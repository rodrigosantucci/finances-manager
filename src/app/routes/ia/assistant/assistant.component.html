<page-header class="bg-dark text-light" title="Assistente IA" />

<div class="container">
  <mat-card class="control-card">
    <mat-card-content>
      <mat-tab-group dynamicHeight class="futuristic-tabs" (selectedTabChange)="onTabChange($event.index)">
        <mat-tab label="Análise de Fundamentos">
          <div class="tab-content">
            <div class="actions-header" style="display: flex; justify-content: center; margin-bottom: 10px;">
              <button mat-raised-button color="primary" (click)="generateFundamentos()" [disabled]="isLoading">
                <mat-icon>auto_awesome</mat-icon> Gerar Análise Fundamentalista
              </button>
            </div>
            <div *ngIf="fundamentos || allFundamentos.length > 0; else noDataFundamentos">
              <div class="report-header">
                <h3>
                  Nota Geral:
                  <span class="stars-container">
                    <mat-icon *ngFor="let star of getStars(fundamentos?.nota || 0)" class="star-icon">{{ star }}</mat-icon>
                  </span>
                </h3>
                <mat-form-field appearance="outline" class="date-select-field">
                  <mat-label>Data da Análise</mat-label>
                  <mat-select [value]="selectedFundamentosDate" (valueChange)="loadFundamentosByDate($event)" [disabled]="allFundamentos.length === 0">
                    <mat-option *ngFor="let analise of allFundamentos" [value]="analise.data">
                      {{ analise.data | date: 'dd/MM/yyyy' }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>


                <div class="panel-grid" *ngIf="fundamentos">
                    <mat-expansion-panel *ngFor="let ativo of fundamentos.analise.ativos" class="futuristic-panel">
                      <mat-expansion-panel-header>
                        <mat-panel-title>{{ ativo.ticker }}</mat-panel-title>
                        <mat-panel-description>
                          Preço Teto: R$ {{ ativo.preco_teto | number: '1.2-2' }} | Nota: {{ ativo.nota | number: '1.1-1' }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>
                      <mat-list dense>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Visão Geral:</strong> {{ ativo.ratings_heuristics.visao_geral }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Panorama Geral:</strong> {{ ativo.ratings_heuristics.panorama_geral }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Cinco Forças:</strong> {{ ativo.ratings_heuristics.cinco_forcas }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Barreiras de Entrada:</strong> {{ ativo.ratings_heuristics.barreiras_entrada }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Rivalidade:</strong> {{ ativo.ratings_heuristics.rivalidade }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Disrupção:</strong> {{ ativo.ratings_heuristics.disrupcao }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Específico da Empresa:</strong> {{ ativo.ratings_heuristics.especifico_empresa }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Interação com a Empresa:</strong> {{ ativo.ratings_heuristics.interacao_empresa }}
                          </div>
                        </mat-list-item>
                        <mat-list-item>
                          <div class="qa-item">
                            <strong>Marcas:</strong> {{ ativo.ratings_heuristics.marcas }}
                          </div>
                        </mat-list-item>
                      </mat-list>

                      <mat-list dense>
                        <mat-list-item *ngFor="let pr of ativo.perguntas_respostas">
                          <div class="qa-item">
                            <p matLine><strong>Pergunta:</strong> {{ pr.pergunta }}</p>
                            <p matLine><strong>Resposta:</strong> {{ pr.resposta }}</p>
                          </div>
                        </mat-list-item>
                      </mat-list>
                    </mat-expansion-panel>
                </div>
                <p class="no-data" *ngIf="!fundamentos && allFundamentos.length > 0">Selecione uma data para carregar a análise.</p>
              </div>
            </div>
            <ng-template #noDataFundamentos>
              <p class="no-data">Nenhum dado ou data disponível para Análise de Fundamentos.</p>
            </ng-template>
          </div>
        </mat-tab>

        <mat-tab label="Análise Técnica">
           <div class="tab-content">
            <div class="actions-header" style="display: flex; justify-content: center; margin-bottom: 10px;">
              <button mat-raised-button color="primary" (click)="generateTecnica()" [disabled]="isLoading">
                <mat-icon>auto_awesome</mat-icon> Gerar Análise Técnica
              </button>
            </div>
            <div *ngIf="tecnica || allTecnica.length > 0; else noDataTecnica">
              <div class="report-header">
                <h3>
                  Nota Geral:
                  <span class="stars-container">
                    <mat-icon *ngFor="let star of getStars(tecnica?.nota || 0)" class="star-icon">{{ star }}</mat-icon>
                  </span>
                </h3>
                <mat-form-field appearance="outline" class="date-select-field">
                  <mat-label>Data da Análise</mat-label>
                  <mat-select [value]="selectedTecnicaDate" (valueChange)="loadTecnicaByDate($event)" [disabled]="allTecnica.length === 0">
                    <mat-option *ngFor="let analise of allTecnica" [value]="analise.data">
                      {{ analise.data | date: 'dd/MM/yyyy' }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>


                <div class="panel-grid" *ngIf="tecnica">
                  <mat-expansion-panel *ngFor="let ativo of tecnica.analise.ativos" class="futuristic-panel">
                    <mat-expansion-panel-header>
                      <mat-panel-title style="flex-grow: 0; margin-right: 16px;">
                        {{ ativo.ticker }}
                      </mat-panel-title>
                      <mat-panel-description style="justify-content: center; flex-grow: 1;">
                           Lucro Ultimo Trimestre: {{ ativo.lucro_ultimo_trimestre | currency:'BRL' }} | Dividend Yield: {{ ativo.dividend_yield }}% | Divida Bruta: {{ ativo.divida_bruta | currency:'BRL' }} | Valor Patrimonial: {{ ativo.valor_patrimonial | currency:'BRL' }}
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <mat-list dense>
                      <mat-list-item>
                        <div class="qa-item">
                          <strong>Indicadores:</strong>
                          <mat-list dense>
                            <mat-list-item *ngFor="let indicador of ativo.indicadores">
                              <p matLine>
                                {{ indicador.indicador }}: {{ indicador.valor }} (Nota: {{ indicador.nota | number: '1.1-1' }})
                              </p>
                            </mat-list-item>
                          </mat-list>
                        </div>
                      </mat-list-item>
                      <mat-list-item>
                        <div class="qa-item">
                          <strong>Recomendações:</strong>
                          <mat-list dense>
                            <mat-list-item *ngFor="let rec of ativo.recomendacoes">
                              <p matLine>{{ rec.recomendacao }}: {{ rec.texto }}</p>
                            </mat-list-item>
                          </mat-list>
                        </div>
                      </mat-list-item>

                      <mat-list-item>
                        <div class="qa-item">
                          <strong>Fator Competitivo:</strong>
                          <mat-list dense>
                            <mat-list-item *ngFor="let fc of ativo.fator_competitivo">
                              <p matLine>
                                {{ fc.recomendacao }}: {{ fc.texto }}
                              </p>
                            </mat-list-item>
                          </mat-list>
                        </div>
                      </mat-list-item>

                      <mat-list-item>
                        <div class="qa-item">
                          <strong>Perguntas e Respostas:</strong>
                          <mat-list dense>
                            <mat-list-item *ngFor="let pr of ativo.perguntas_respostas">
                              <p matLine><strong>Pergunta:</strong> {{ pr.pergunta }}</p>
                              <p matLine><strong>Resposta:</strong> {{ pr.resposta }}</p>
                            </mat-list-item>
                          </mat-list>
                        </div>
                      </mat-list-item>
                    </mat-list>
                  </mat-expansion-panel>
                </div>
                <p class="no-data" *ngIf="!tecnica && allTecnica.length > 0">Selecione uma data para carregar a análise.</p>
              </div>
            </div>
            <ng-template #noDataTecnica>
              <p class="no-data">Nenhum dado ou data disponível para Análise Técnica.</p>
            </ng-template>
          </div>
        </mat-tab>

        <mat-tab label="Análise de Objetivos Pessoais">
          <div class="tab-content">
            <div class="actions-header" style="display: flex; justify-content: center; margin-bottom: 10px;">
              <button mat-raised-button color="primary" (click)="generatePessoais()" [disabled]="isLoading">
                <mat-icon>auto_awesome</mat-icon> Gerar Análise Pessoal
              </button>
            </div>
            <div *ngIf="pessoais || allPessoais.length > 0; else noDataPessoais">
              <div class="report-header">
                <h3>
                  Nota Geral:
                  <span class="stars-container">
                    <mat-icon *ngFor="let star of getStars(pessoais?.nota || 0)" class="star-icon">{{ star }}</mat-icon>
                  </span>
                </h3>
                <mat-form-field appearance="outline" class="date-select-field">
                  <mat-label>Data da Análise</mat-label>
                  <mat-select [value]="selectedPessoaisDate" (valueChange)="loadPessoaisByDate($event)" [disabled]="allPessoais.length === 0">
                    <mat-option *ngFor="let analise of allPessoais" [value]="analise.data">
                      {{ analise.data | date: 'dd/MM/yyyy' }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>


                <div class="card-grid" *ngIf="pessoais">
                  <mat-card class="info-card futuristic-card">
                    <mat-card-header>
                      <mat-card-title>Estratégia Sugerida</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <p>{{ pessoais.analise.estrategia_sugerida }}</p>
                    </mat-card-content>
                  </mat-card>
                  <mat-card class="info-card futuristic-card">
                    <mat-card-header>
                      <mat-card-title>Alocação Sugerida</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <div #chartElement id="assistant-chart" class="chart">
                        </div>
                    </mat-card-content>
                  </mat-card>
                  <mat-card class="info-card futuristic-card">
                    <mat-card-header>
                      <mat-card-title>Desempenho e Estimativas</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <mat-list dense>
                        <mat-list-item>
                          <p matLine>Retorno Anual Esperado: {{ pessoais.analise.desempenho_estimativas.retorno_anual_esperado }}%</p>
                        </mat-list-item>
                        <mat-list-item>
                          <p matLine>Volatilidade Esperada: {{ pessoais.analise.desempenho_estimativas.volatilidade_esperada }}%</p>
                        </mat-list-item>
                        <mat-list-item>
                          <p matLine>Período de Análise: {{ pessoais.analise.desempenho_estimativas.periodo_analise }}</p>
                        </mat-list-item>
                        <mat-list-item>
                         <p>Estimativa 1 Ano: {{ pessoais.analise.desempenho_estimativas.patrimonio_1_ano | currency: 'BRL':'symbol':'1.2-2' }}</p>
                        </mat-list-item>
                        <mat-list-item>
                          <p>Estimativa 5 Anos: {{ pessoais.analise.desempenho_estimativas.patrimonio_5_anos | currency: 'BRL':'symbol':'1.2-2' }}</p>
                        </mat-list-item>
                        <mat-list-item>
                          <p>Estimativa 10 Anos: {{ pessoais.analise.desempenho_estimativas.patrimonio_10_anos | currency: 'BRL':'symbol':'1.2-2' }}</p>
                        </mat-list-item>
                      </mat-list>
                    </mat-card-content>
                  </mat-card>
                  <mat-expansion-panel class="futuristic-panel">
                    <mat-expansion-panel-header>
                      <mat-panel-title>Perguntas e Respostas</mat-panel-title>
                    </mat-expansion-panel-header>
                    <mat-list dense>
                      <mat-list-item *ngFor="let pr of pessoais.analise.perguntas_respostas">
                        <div class="qa-item">
                          <p matLine><strong>Pergunta:</strong> {{ pr.pergunta }}</p>
                          <p matLine><strong>Resposta:</strong> {{ pr.resposta }}</p>
                        </div>
                      </mat-list-item>
                    </mat-list>
                  </mat-expansion-panel>
                </div>
                <p class="no-data" *ngIf="!pessoais && allPessoais.length > 0">Selecione uma data para carregar a análise.</p>
              </div>
            </div>
            <ng-template #noDataPessoais>
              <p class="no-data">Nenhum dado ou data disponível para Objetivos Pessoais.</p>
            </ng-template>
          </div>
        </mat-tab>
      </mat-tab-group>

      <div class="action-bar">
        <button
          mat-icon-button
          color="primary"
          (click)="loadAssistantData()"
          matTooltip="Recarregar dados (Atual/Selecionado)"
          aria-label="Recarregar dados"
          [disabled]="isLoading"
          class="action-button"
        >
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
      <mat-progress-spinner
        *ngIf="isLoading"
        mode="indeterminate"
        diameter="40"
        class="spinner"
      ></mat-progress-spinner>
    </mat-card-content>
  </mat-card>
</div>
