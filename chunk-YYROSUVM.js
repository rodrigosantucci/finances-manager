import{c as D,mc as U,oc as N}from"./chunk-XL6CURNC.js";import{D as l,H as T,T as v,W as F,Z as m,aa as y,ga as C,m as c,n as p,q as d,w as $}from"./chunk-ZCYO3KUH.js";import{a as f,b as I}from"./chunk-4X36HX5K.js";var O={production:!0,baseUrl:"https://apis.dividendosparatodos.com.br/services/",authUrl:"https://apis.dividendosparatodos.com.br/services/",useHash:!1};var L=(()=>{class h{constructor(){this.http=C(D),this.authService=C(N),this.store=C(U),this.apiUserPatrimonioPrefix="/api/patrimonios/usuario",this.apiCotacoesPrefix="/api/cotacoes/tickers",this.apiTransacoesPrefix="/api/transacoes/lote",this.PATRIMONIO_COMPLETO_KEY="patrimonioCompletoCache",this.PATRIMONIO_HISTORICO_KEY="patrimonioHistoricoCache",this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null,this.patrimonioHistoricoCache$=null,this.apiUrl="/api"}getUsuarioIdObservable(){return this.authService.user().pipe(T(1),d(r=>r?.id))}createTransactionLote(r,o){let t=`${this.apiTransacoesPrefix}/${r}`;return this.http.post(t,o).pipe(m(()=>this.clearPatrimonioCache()))}createTransaction(r,o){let t=`${this.apiUrl}/transacoes/${r}/criarTransacao`;return this.http.post(t,o).pipe(m(()=>this.clearPatrimonioCache()))}getCotacaoUSD(){if(!this.cotacaoUSDCache$){let r=`${this.apiCotacoesPrefix}?tickers=USD/BRL`;this.cotacaoUSDCache$=this.http.get(r).pipe(d(o=>{if(!o||o.length===0)return console.warn("DashboardService: Empty or null USD quote response. Returning 0."),0;let t=o[0].valorCotacao;return typeof t!="number"||isNaN(t)||t<=0?(console.warn("DashboardService: Invalid 'valorCotacao' in response. Returning 0.",o[0]),0):t}),l(o=>(console.error("DashboardService: HTTP error fetching USD quote. Returning 0.",o),c(0))),v(1))}return this.cotacaoUSDCache$}parseFormattedString(r){if(r==null||r.trim()==="")return 0;let o=r.trim();o=o.replace(/[^\d.,-]/g,""),o.includes(",")&&o.includes(".")?o.indexOf(",")>o.indexOf(".")?(o=o.replace(/\./g,""),o=o.replace(/,/g,".")):o=o.replace(/,/g,""):o.includes(",")&&(o=o.replace(/,/g,"."));let t=parseFloat(o);return isNaN(t)?(console.warn(`[DashboardService.parseFormattedString] Failed to parse: "${r}" -> "${o}". Returning 0.`),0):t}convertUsdToBrlNumeric(r,o){return o<=0?(console.warn(`[convertUsdToBrlNumeric] Invalid or zero USD quote (${o}). Returning assets without numeric conversion.`),r):r.map(t=>{let e=f({},t);if(e.moedaFormatada==="USD"){let n=this.parseFormattedString(e.valorAtualFormatado?.toString());e.valorAtualFormatado=isNaN(n)?0:n*o;let a=this.parseFormattedString(e.valorInvestidoFormatado?.toString());e.valorInvestidoFormatado=isNaN(a)?0:a*o;let s=this.parseFormattedString(e.precoMedioFormatado?.toString());e.precoMedioFormatado=isNaN(s)?0:s*o,e.lucroPrejuizoFormatado=e.valorAtualFormatado-e.valorInvestidoFormatado,e.moedaFormatada="BRL"}else e.valorAtualFormatado=this.parseFormattedString(e.valorAtualFormatado?.toString()),e.valorInvestidoFormatado=this.parseFormattedString(e.valorInvestidoFormatado?.toString()),e.precoMedioFormatado=this.parseFormattedString(e.precoMedioFormatado?.toString()),e.lucroPrejuizoFormatado=this.parseFormattedString(e.lucroPrejuizoFormatado?.toString());return e.quantidadeFormatada=this.parseFormattedString(e.quantidadeFormatada?.toString()),e})}getPatrimonioCompleto(){return this.patrimonioCompletoCache$||(this.patrimonioCompletoCache$=this.getUsuarioIdObservable().pipe(F(r=>{if(r==null)return console.error("User ID not available for fetching complete patrimony."),c([]);let o=`${this.apiUserPatrimonioPrefix}/${r}/patrimoniocompleto`;return $({patrimonio:this.http.get(o),cotacao:this.getCotacaoUSD()}).pipe(F(({patrimonio:t,cotacao:e})=>{if(!t||t.length===0)return c([]);let n=t.map(i=>({id:i.id,tickerFormatado:i.tickerFormatado,descricaoFormatada:i.descricaoFormatada,tipoAtivoFormatado:i.tipoAtivoFormatado,moedaFormatada:i.moedaFormatada,quantidadeFormatada:this.parseFormattedString(i.quantidadeFormatada),valorInvestidoFormatado:this.parseFormattedString(i.valorInvestidoFormatado),precoMedioFormatado:this.parseFormattedString(i.precoMedioFormatado),precoAtualFormatado:0,valorAtualFormatado:this.parseFormattedString(i.valorAtualFormatado),lucroPrejuizoFormatado:this.parseFormattedString(i.lucroPrejuizoFormatado),moeda:i.moeda,category:this.mapTipoAtivoToCategory(i.tipoAtivoFormatado)})),a=this.convertUsdToBrlNumeric(n,e),s=a.filter(i=>i.tipoAtivoFormatado!=="CAIXA").map(i=>i.tickerFormatado);if(s.length>0){let i=`${this.apiCotacoesPrefix}?tickers=${s.join(",")}`;return this.http.get(i).pipe(d(S=>{let P=new Map(S.map(u=>[u.ticker,{valorCotacao:u.valorCotacao,cambio:u.cambio}]));return a.map(u=>{if(u.tipoAtivoFormatado==="CAIXA")return u;let g=P.get(u.tickerFormatado),A=g?g.cambio==="USD"?g.valorCotacao*e:g.valorCotacao:0,b=u.quantidadeFormatada*A,E=b-u.valorInvestidoFormatado;return I(f({},u),{precoAtualFormatado:A,valorAtualFormatado:b,lucroPrejuizoFormatado:E})})}),l(S=>(console.error("DashboardService: Error fetching quotes for complete patrimony:",S),c(a.map(P=>I(f({},P),{precoAtualFormatado:0}))))))}return c(a)}),m(t=>this.store.set(this.PATRIMONIO_COMPLETO_KEY,t)),l(t=>(console.error("DashboardService: Error fetching complete patrimony for user:",t),c([]))))}),v(1))),this.patrimonioCompletoCache$}getPatrimonioHistorico(r){return this.patrimonioHistoricoCache$||(this.patrimonioHistoricoCache$=this.getUsuarioIdObservable().pipe(F(o=>{if(o==null)return console.error("User ID not available for fetching historical patrimony."),c([]);if(o!==r)return console.warn("User ID mismatch: auth ID does not match requested ID."),c([]);let t=`${this.apiUserPatrimonioPrefix}/${r}/historico`;return $({historico:this.http.get(t).pipe(d(e=>e.map(n=>({idHistorico:n.idHistorico,usuarioId:n.usuarioId,dataRegistro:this.validateDate(n.dataRegistro)??new Date().toISOString(),valorTotal:this.validateNumber(n.valorTotal)??0})).filter(n=>n.dataRegistro!==null&&n.valorTotal!==null)),l(e=>(console.error("DashboardService: Error fetching historical patrimony for user:",e),c([])))),completo:this.getPatrimonioCompleto()}).pipe(d(({historico:e,completo:n})=>!e||e.length===0?(console.warn("No historical data available for user."),[]):e),m(e=>this.store.set(this.PATRIMONIO_HISTORICO_KEY,e)),l(e=>(console.error("DashboardService: Error processing historical patrimony:",e),c([]))),v(1))}))),this.patrimonioHistoricoCache$}getDistribuicaoPatrimonio(){return this.getPatrimonioCompleto().pipe(d(r=>this.calculateDistribuicao(r)),l(r=>(console.error("DashboardService: Error fetching patrimony distribution:",r),c([]))))}calculateDistribuicao(r){if(!r||r.length===0)return[];let o={};r.forEach(a=>{let s=a.category||"outros";o[s]=(o[s]||0)+(a.valorAtualFormatado||0)});let t=Object.entries(o).map(([a,s])=>({tipoAtivo:a.charAt(0).toUpperCase()+a.slice(1),valorTotal:s,percentual:0})),e=t.reduce((a,s)=>a+s.valorTotal,0);return t.map(a=>(a.percentual=e>0?a.valorTotal/e*100:0,a.percentual=Math.round(a.percentual*100)/100,a))}getPatrimonioAcoes(){return this.getPatrimonioCompleto().pipe(d(r=>r.filter(o=>o.category==="acoes")),l(r=>(console.error("DashboardService: Error filtering actions from complete patrimony:",r),c([]))))}getPatrimonioFundos(){return this.getPatrimonioCompleto().pipe(d(r=>r.filter(o=>o.category==="fundos")),l(r=>(console.error("DashboardService: Error filtering funds from complete patrimony:",r),c([]))))}getPatrimonioCaixa(){return this.getPatrimonioCompleto().pipe(d(r=>r.filter(o=>o.category==="caixa")),l(r=>(console.error("DashboardService: Error filtering cash from complete patrimony:",r),c([]))))}getPatrimonioAssets(){return this.getPatrimonioCompleto().pipe(d(r=>r.filter(o=>o.category==="assets")),l(r=>(console.error("DashboardService: Error filtering assets from complete patrimony:",r),c([]))))}getStoredPatrimonioCompleto(){return this.store.get(this.PATRIMONIO_COMPLETO_KEY)||[]}getStoredPatrimonioHistorico(){return this.store.get(this.PATRIMONIO_HISTORICO_KEY)||[]}getStoredDistribuicaoPatrimonio(){let r=this.getStoredPatrimonioCompleto();return this.calculateDistribuicao(r)}getStoredPatrimonioAcoes(){return this.getStoredPatrimonioCompleto().filter(o=>o.category==="acoes")}getStoredPatrimonioFundos(){return this.getStoredPatrimonioCompleto().filter(o=>o.category==="fundos")}getStoredPatrimonioCaixa(){return this.getStoredPatrimonioCompleto().filter(o=>o.category==="caixa")}getStoredPatrimonioAssets(){return this.getStoredPatrimonioCompleto().filter(o=>o.category==="assets")}deleteAtivo(r,o,t){if(!["fundos","acoes","caixa","assets"].includes(t))return console.error(`Invalid category for deletion: ${t}`),p(()=>new Error("Invalid category"));let e=encodeURIComponent(o),n=`${this.apiUserPatrimonioPrefix}/${r}/${e}`;return this.http.delete(n,{observe:"response"}).pipe(m(a=>{a.status===204?(console.log(`Ticker ${o} deleted successfully from category ${t} (204 No Content).`),this.clearPatrimonioCache()):console.warn(`Unexpected response deleting ticker ${o}: status ${a.status}`)}),d(()=>{}),l(a=>(console.error(`Error deleting ticker ${o} from category ${t}:`,a),p(()=>new Error(`Error deleting ticker: ${a.message||"Unknown error"}`)))))}updateAtivo(r,o,t){if(!["fundos","acoes","caixa","assets","outros"].includes(t))return console.error(`Invalid category for update: ${t}`),p(()=>new Error("Invalid category"));if(!o.tickerFormatado||o.tickerFormatado.trim()==="")return console.error(`Invalid ticker for asset in category ${t}:`,o),p(()=>new Error("Invalid ticker"));let e=encodeURIComponent(o.tickerFormatado),n=`${this.apiUserPatrimonioPrefix}/${r}/${e}`,a={idPatrimonio:typeof o.id=="string"?Number(o.id):o.id||0,descricao:o.descricaoFormatada||"",quantidade:o.quantidadeFormatada||0,precoMedio:o.precoMedioFormatado||0,valorInvestido:o.valorInvestidoFormatado||0,ticker:o.tickerFormatado,usuario:{id:Number(r)||0},tipoAtivo:this.mapCategoryToTipoAtivoNumber(t),moeda:o.moeda||"BRL"};if(a.tipoAtivo===3){let s=typeof o.valorAtualFormatado=="string"?parseFloat(o.valorAtualFormatado.replace(",","."))||0:typeof o.valorAtualFormatado=="number"?o.valorAtualFormatado:0;s>0&&(a.valorAtual=s)}return this.http.put(n,a,{headers:{"Content-Type":"application/json"}}).pipe(m(()=>{console.log(`Asset with ticker ${o.tickerFormatado} updated successfully in category ${t}.`),this.clearPatrimonioCache()}),l(s=>(console.error(`Error updating asset with ticker ${o.tickerFormatado} in category ${t}:`,s),p(()=>new Error(`Error updating asset: ${s.message||"Unknown error"}`)))))}addTransaction(r,o){let t=o.category;return["fundos","acoes","assets","caixa"].includes(t)?(this.clearPatrimonioCache(),c({success:!0})):(console.error(`Invalid category for transaction: ${t}`),p(()=>new Error("Invalid category")))}clearPatrimonioCache(){this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null,this.patrimonioHistoricoCache$=null,console.log("DashboardService: Patrimony and historical cache cleared.")}mapTipoAtivoToCategory(r){switch(r.toUpperCase()){case"A\xC7\xC3O":return"acoes";case"FII":case"FUNDO":return"fundos";case"CAIXA":return"caixa";case"ASSET":return"assets";default:return"outros"}}mapCategoryToTipoAtivoNumber(r){switch(r.toLowerCase()){case"acoes":return 1;case"fundos":return 2;case"caixa":return 3;case"assets":return 4;default:return 0}}validateDate(r){if(!r){console.warn(`Invalid date: ${r}`);return}let o=/^(\d{2})\/(\d{2})\/(\d{4})$/,t=r.match(o);if(t){let n=parseInt(t[1],10),a=parseInt(t[2],10)-1,s=parseInt(t[3],10),i=new Date(s,a,n);if(!isNaN(i.getTime())&&i.getDate()===n&&i.getMonth()===a&&i.getFullYear()===s)return r;console.warn(`Invalid date values: ${r}`);return}let e=new Date(r);if(!isNaN(e.getTime()))return r;console.warn(`Invalid date format: ${r}`)}validateNumber(r){let o=parseFloat(r);if(isNaN(o)){console.warn(`Invalid number format: ${r}`);return}return o}static{this.\u0275fac=function(o){return new(o||h)}}static{this.\u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();export{O as a,L as b};
