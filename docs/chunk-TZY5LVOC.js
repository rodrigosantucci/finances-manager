import{c as x,nc as E}from"./chunk-KVOOXQ5Z.js";import{D as c,H as k,T as C,W as $,Z as A,aa as U,ga as S,m as n,n as p,q as u,w as T}from"./chunk-IW7VSEPZ.js";import{a as F,b as f}from"./chunk-4X36HX5K.js";var N={production:!0,baseUrl:"https://apis.dividendosparatodos.com.br/services/",authUrl:"https://apis.dividendosparatodos.com.br/services/",useHash:!1};var q=(()=>{class m{constructor(){this.http=S(x),this.authService=S(E),this.apiUserPatrimonioPrefix="/api/patrimonios/usuario/",this.apiCotacoesPrefix="/api/cotacoes/tickers/",this.apiTransacoesPrefix="/api/transacoes/lote/",this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null,this.apiUrl="/api"}getUsuarioIdObservable(){return this.authService.user().pipe(k(1),u(r=>r?.id))}createTransactionLote(r,o){let a=`${this.apiTransacoesPrefix}${r}`;return this.http.post(a,o)}createTransaction(r,o){let a=`${this.apiUrl}/transacoes/${r}/criarTransacao`;return this.http.post(a,o)}getCotacaoUSD(){if(!this.cotacaoUSDCache$){let r=`${this.apiCotacoesPrefix}?tickers=USD/BRL`;this.cotacaoUSDCache$=this.http.get(r).pipe(u(o=>{if(!o||o.length===0)return console.warn("DashboardService: Resposta da API de cota\xE7\xE3o veio vazia ou nula para USD. Retornando 0."),0;let a=o[0].valorCotacao;return typeof a!="number"||isNaN(a)||a<=0?(console.warn("DashboardService: A propriedade 'valorCotacao' \xE9 inv\xE1lida no primeiro item da resposta. Retornando 0.",o[0]),0):a}),c(o=>(console.error("DashboardService: Erro HTTP ao buscar cota\xE7\xE3o USD. Retornando 0.",o),n(0))),C(1))}return this.cotacaoUSDCache$}parseFormattedString(r){if(r==null||r.trim()==="")return 0;let o=r.trim();o=o.replace(/[^\d.,-]/g,""),o.includes(",")&&o.includes(".")?o.indexOf(",")>o.indexOf(".")?(o=o.replace(/\./g,""),o=o.replace(/,/g,".")):o=o.replace(/,/g,""):o.includes(",")&&(o=o.replace(/,/g,"."));let a=parseFloat(o);return isNaN(a)?(console.warn(`[DashboardService.parseFormattedString] Falha ao parsear: "${r}" -> "${o}". Retornando 0.`),0):a}convertUsdToBrlNumeric(r,o){return o<=0?(console.warn(`[convertUsdToBrlNumeric] Cota\xE7\xE3o USD inv\xE1lida ou zero (${o}). Retornando ativos sem convers\xE3o num\xE9rica.`),r):r.map(a=>{let t=F({},a);if(t.moedaFormatada==="USD"){let d=this.parseFormattedString(t.valorAtualFormatado?.toString());isNaN(d)?t.valorAtualFormatado=0:t.valorAtualFormatado=d*o;let e=this.parseFormattedString(t.valorInvestidoFormatado?.toString());isNaN(e)?t.valorInvestidoFormatado=0:t.valorInvestidoFormatado=e*o;let i=this.parseFormattedString(t.precoMedioFormatado?.toString());isNaN(i)?t.precoMedioFormatado=0:t.precoMedioFormatado=i*o,t.lucroPrejuizoFormatado=t.valorAtualFormatado-t.valorInvestidoFormatado,t.moedaFormatada="BRL"}else t.valorAtualFormatado=this.parseFormattedString(t.valorAtualFormatado?.toString()),t.valorInvestidoFormatado=this.parseFormattedString(t.valorInvestidoFormatado?.toString()),t.precoMedioFormatado=this.parseFormattedString(t.precoMedioFormatado?.toString()),t.lucroPrejuizoFormatado=this.parseFormattedString(t.lucroPrejuizoFormatado?.toString());return t.quantidadeFormatada=this.parseFormattedString(t.quantidadeFormatada?.toString()),t})}getPatrimonioCompleto(){return this.patrimonioCompletoCache$||(this.patrimonioCompletoCache$=this.getUsuarioIdObservable().pipe($(r=>{if(r==null)return console.error("ID do usu\xE1rio n\xE3o dispon\xEDvel para buscar patrim\xF4nio completo."),n([]);let o=`${this.apiUserPatrimonioPrefix}${r}/patrimoniocompleto`;return T({patrimonio:this.http.get(o),cotacao:this.getCotacaoUSD()}).pipe($(({patrimonio:a,cotacao:t})=>{if(!a||a.length===0)return n([]);let d=a.map(s=>({id:s.ticker,tickerFormatado:s.tickerFormatado,descricaoFormatada:s.descricaoFormatada,tipoAtivoFormatado:s.tipoAtivoFormatado,moedaFormatada:s.moedaFormatada,quantidadeFormatada:this.parseFormattedString(s.quantidadeFormatada),valorInvestidoFormatado:this.parseFormattedString(s.valorInvestidoFormatado),precoMedioFormatado:this.parseFormattedString(s.precoMedioFormatado),precoAtualFormatado:0,valorAtualFormatado:this.parseFormattedString(s.valorAtualFormatado),lucroPrejuizoFormatado:this.parseFormattedString(s.lucroPrejuizoFormatado),moeda:s.moeda,category:this.mapTipoAtivoToCategory(s.tipoAtivoFormatado)})),e=this.convertUsdToBrlNumeric(d,t),i=e.filter(s=>s.tipoAtivoFormatado!=="CAIXA").map(s=>s.tickerFormatado);if(i.length>0){let s=`${this.apiCotacoesPrefix}?tickers=${i.join(",")}`;return this.http.get(s).pipe(u(v=>{let g=new Map(v.map(l=>[l.ticker,{valorCotacao:l.valorCotacao,cambio:l.cambio}]));return e.map(l=>{if(l.tipoAtivoFormatado==="CAIXA")return l;let h=g.get(l.tickerFormatado),b=h?h.cambio==="USD"?h.valorCotacao*t:h.valorCotacao:0,P=l.quantidadeFormatada*b,D=P-l.valorInvestidoFormatado;return f(F({},l),{precoAtualFormatado:b,valorAtualFormatado:P,lucroPrejuizoFormatado:D})})}),c(v=>(console.error("DashboardService: Erro ao buscar cota\xE7\xF5es para o patrim\xF4nio completo:",v),n(e.map(g=>f(F({},g),{precoAtualFormatado:0}))))))}else return n(e)}),c(a=>(console.error(`DashboardService: Erro ao buscar patrim\xF4nio completo para usu\xE1rio ${r}:`,a),n([]))))}),C(1))),this.patrimonioCompletoCache$}getDistribuicaoPatrimonio(){return this.getPatrimonioCompleto().pipe(u(r=>{if(!r||r.length===0)return[];let o={};r.forEach(e=>{let i=e.category||"outros";o[i]=(o[i]||0)+(e.valorAtualFormatado||0)});let a=Object.entries(o).map(([e,i])=>({tipoAtivo:e.charAt(0).toUpperCase()+e.slice(1),valorTotal:i,percentual:0})),t=a.reduce((e,i)=>e+i.valorTotal,0);return a.map(e=>(e.percentual=t>0?e.valorTotal/t*100:0,e.percentual=Math.round(e.percentual*100)/100,e))}),c(r=>(console.error("DashboardService: Erro ao buscar distribui\xE7\xE3o de patrim\xF4nio:",r),n([]))))}getPatrimonioAcoes(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="acoes")),c(r=>(console.error("DashboardService: Erro ao filtrar a\xE7\xF5es do patrim\xF4nio completo:",r),n([]))))}getPatrimonioFundos(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="fundos")),c(r=>(console.error("DashboardService: Erro ao filtrar fundos do patrim\xF4nio completo:",r),n([]))))}getPatrimonioCaixa(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="caixa")),c(r=>(console.error("DashboardService: Erro ao filtrar caixa do patrim\xF4nio completo:",r),n([]))))}getPatrimonioAssets(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="assets")),c(r=>(console.error("DashboardService: Erro ao filtrar assets do patrim\xF4nio completo:",r),n([]))))}deleteAtivo(r,o,a){if(!["fundos","acoes","caixa","assets"].includes(a))return console.error(`Categoria inv\xE1lida para exclus\xE3o: ${a}`),p(()=>new Error("Categoria inv\xE1lida"));let t=encodeURIComponent(o),d=`${this.apiUserPatrimonioPrefix}${r}/${t}`;return this.http.delete(d,{observe:"response"}).pipe(A(e=>{e.status===204?(console.log(`Ticker ${o} exclu\xEDdo com sucesso da categoria ${a} (204 No Content).`),this.patrimonioCompletoCache$=null):console.warn(`Resposta inesperada ao excluir Ticker ${o}: status ${e.status}`)}),u(()=>{}),c(e=>(console.error(`Erro ao excluir Ticker ${o} da categoria ${a}:`,e),p(()=>new Error(`Erro ao excluir Ticker: ${e.message||"Erro desconhecido"}`)))))}updateAtivo(r,o,a){if(!["fundos","acoes","caixa","assets","outros"].includes(a))return console.error(`Categoria inv\xE1lida para atualiza\xE7\xE3o: ${a}`),p(()=>new Error("Categoria inv\xE1lida"));if(!o.tickerFormatado||o.tickerFormatado.trim()==="")return console.error(`Ticker inv\xE1lido para ativo na categoria ${a}:`,o),p(()=>new Error("Ticker inv\xE1lido"));let t=encodeURIComponent(o.tickerFormatado),d=`${this.apiUserPatrimonioPrefix}${r}/${t}`;console.log("URL de atualiza\xE7\xE3o gerada:",d);let e={idPatrimonio:typeof o.id=="string"?Number(o.id):o.id||0,descricao:o.descricaoFormatada||"",quantidade:o.quantidadeFormatada||0,precoMedio:o.precoMedioFormatado||0,valorInvestido:o.valorInvestidoFormatado||0,ticker:o.tickerFormatado,usuario:{id:Number(r)||0},tipoAtivo:this.mapCategoryToTipoAtivoNumber(a),moeda:o.moeda||"BRL"};if(e.tipoAtivo===3){let i=typeof o.valorAtualFormatado=="string"?parseFloat(o.valorAtualFormatado.replace(",","."))||0:typeof o.valorAtualFormatado=="number"?o.valorAtualFormatado:0;i>0?(e.valorAtual=i,console.log(`Incluindo valorAtual=${i} para ticker ${o.tickerFormatado} (Caixa)`)):console.warn(`valorAtualFormatado inv\xE1lido (${o.valorAtualFormatado}) para ticker ${o.tickerFormatado} (Caixa). N\xE3o inclu\xEDdo.`)}return console.log("Objeto enviado para atualiza\xE7\xE3o:",e),this.http.put(d,e,{headers:{"Content-Type":"application/json"}}).pipe(A(()=>{console.log(`Ativo com ticker ${o.tickerFormatado} atualizado com sucesso na categoria ${a}.`),this.patrimonioCompletoCache$=null}),c(i=>{console.error(`Erro ao atualizar ativo com ticker ${o.tickerFormatado} na categoria ${a}:`,{status:i.status,statusText:i.statusText,error:i.error,requestBody:e});let s=i.error?.attributeName&&i.error?.objectName?`Erro de valida\xE7\xE3o no campo '${i.error.attributeName}' para o objeto '${i.error.objectName}'. Valor inv\xE1lido: '${i.error.value}'`:i.error?.message||i.message||"Erro desconhecido";return p(()=>new Error(`Erro ao atualizar ativo: ${s}`))}))}addTransaction(r,o){let a=o.category;return["fundos","acoes","assets","caixa"].includes(a)?(this.patrimonioCompletoCache$=null,n({success:!0})):(console.error(`Categoria inv\xE1lida para transa\xE7\xE3o: ${a}`),p(()=>new Error("Categoria inv\xE1lida")))}clearPatrimonioCache(){this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null}mapTipoAtivoToCategory(r){switch(r.toUpperCase()){case"A\xC7\xC3O":return"acoes";case"FII":case"FUNDO":return"fundos";case"CAIXA":return"caixa";case"ASSET":return"assets";default:return"outros"}}mapCategoryToTipoAtivoNumber(r){switch(r.toLowerCase()){case"acoes":return 1;case"fundos":return 2;case"caixa":return 3;case"assets":return 4;default:return 0}}static{this.\u0275fac=function(o){return new(o||m)}}static{this.\u0275prov=U({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();export{N as a,q as b};
