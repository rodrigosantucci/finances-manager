import{c as U,nc as T}from"./chunk-KVOOXQ5Z.js";import{D as l,H as y,T as v,W as F,Z as h,aa as D,ga as A,m as c,n as p,q as d,w as b}from"./chunk-IW7VSEPZ.js";import{a as g,b as $}from"./chunk-4X36HX5K.js";var N={production:!0,baseUrl:"https://apis.dividendosparatodos.com.br/services/",authUrl:"https://apis.dividendosparatodos.com.br/services/",useHash:!1};var O=(()=>{class m{constructor(){this.http=A(U),this.authService=A(T),this.apiUserPatrimonioPrefix="/api/patrimonios/usuario",this.apiCotacoesPrefix="/api/cotacoes/tickers",this.apiTransacoesPrefix="/api/transacoes/lote",this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null,this.patrimonioHistoricoCache$=null,this.apiUrl="/api"}getUsuarioIdObservable(){return this.authService.user().pipe(y(1),d(o=>o?.id))}createTransactionLote(o,r){let t=`${this.apiTransacoesPrefix}/${o}`;return this.http.post(t,r).pipe(h(()=>this.clearPatrimonioCache()))}createTransaction(o,r){let t=`${this.apiUrl}/transacoes/${o}/criarTransacao`;return this.http.post(t,r).pipe(h(()=>this.clearPatrimonioCache()))}getCotacaoUSD(){if(!this.cotacaoUSDCache$){let o=`${this.apiCotacoesPrefix}?tickers=USD/BRL`;this.cotacaoUSDCache$=this.http.get(o).pipe(d(r=>{if(!r||r.length===0)return console.warn("DashboardService: Empty or null USD quote response. Returning 0."),0;let t=r[0].valorCotacao;return typeof t!="number"||isNaN(t)||t<=0?(console.warn("DashboardService: Invalid 'valorCotacao' in response. Returning 0.",r[0]),0):t}),l(r=>(console.error("DashboardService: HTTP error fetching USD quote. Returning 0.",r),c(0))),v(1))}return this.cotacaoUSDCache$}parseFormattedString(o){if(o==null||o.trim()==="")return 0;let r=o.trim();r=r.replace(/[^\d.,-]/g,""),r.includes(",")&&r.includes(".")?r.indexOf(",")>r.indexOf(".")?(r=r.replace(/\./g,""),r=r.replace(/,/g,".")):r=r.replace(/,/g,""):r.includes(",")&&(r=r.replace(/,/g,"."));let t=parseFloat(r);return isNaN(t)?(console.warn(`[DashboardService.parseFormattedString] Failed to parse: "${o}" -> "${r}". Returning 0.`),0):t}convertUsdToBrlNumeric(o,r){return r<=0?(console.warn(`[convertUsdToBrlNumeric] Invalid or zero USD quote (${r}). Returning assets without numeric conversion.`),o):o.map(t=>{let e=g({},t);if(e.moedaFormatada==="USD"){let n=this.parseFormattedString(e.valorAtualFormatado?.toString());e.valorAtualFormatado=isNaN(n)?0:n*r;let a=this.parseFormattedString(e.valorInvestidoFormatado?.toString());e.valorInvestidoFormatado=isNaN(a)?0:a*r;let s=this.parseFormattedString(e.precoMedioFormatado?.toString());e.precoMedioFormatado=isNaN(s)?0:s*r,e.lucroPrejuizoFormatado=e.valorAtualFormatado-e.valorInvestidoFormatado,e.moedaFormatada="BRL"}else e.valorAtualFormatado=this.parseFormattedString(e.valorAtualFormatado?.toString()),e.valorInvestidoFormatado=this.parseFormattedString(e.valorInvestidoFormatado?.toString()),e.precoMedioFormatado=this.parseFormattedString(e.precoMedioFormatado?.toString()),e.lucroPrejuizoFormatado=this.parseFormattedString(e.lucroPrejuizoFormatado?.toString());return e.quantidadeFormatada=this.parseFormattedString(e.quantidadeFormatada?.toString()),e})}getPatrimonioCompleto(){return this.patrimonioCompletoCache$||(this.patrimonioCompletoCache$=this.getUsuarioIdObservable().pipe(F(o=>{if(o==null)return console.error("User ID not available for fetching complete patrimony."),c([]);let r=`${this.apiUserPatrimonioPrefix}/${o}/patrimoniocompleto`;return b({patrimonio:this.http.get(r),cotacao:this.getCotacaoUSD()}).pipe(F(({patrimonio:t,cotacao:e})=>{if(!t||t.length===0)return c([]);let n=t.map(i=>({id:i.id,tickerFormatado:i.tickerFormatado,descricaoFormatada:i.descricaoFormatada,tipoAtivoFormatado:i.tipoAtivoFormatado,moedaFormatada:i.moedaFormatada,quantidadeFormatada:this.parseFormattedString(i.quantidadeFormatada),valorInvestidoFormatado:this.parseFormattedString(i.valorInvestidoFormatado),precoMedioFormatado:this.parseFormattedString(i.precoMedioFormatado),precoAtualFormatado:0,valorAtualFormatado:this.parseFormattedString(i.valorAtualFormatado),lucroPrejuizoFormatado:this.parseFormattedString(i.lucroPrejuizoFormatado),moeda:i.moeda,category:this.mapTipoAtivoToCategory(i.tipoAtivoFormatado)})),a=this.convertUsdToBrlNumeric(n,e),s=a.filter(i=>i.tipoAtivoFormatado!=="CAIXA").map(i=>i.tickerFormatado);if(s.length>0){let i=`${this.apiCotacoesPrefix}?tickers=${s.join(",")}`;return this.http.get(i).pipe(d(C=>{let S=new Map(C.map(u=>[u.ticker,{valorCotacao:u.valorCotacao,cambio:u.cambio}]));return a.map(u=>{if(u.tipoAtivoFormatado==="CAIXA")return u;let f=S.get(u.tickerFormatado),P=f?f.cambio==="USD"?f.valorCotacao*e:f.valorCotacao:0,I=u.quantidadeFormatada*P,w=I-u.valorInvestidoFormatado;return $(g({},u),{precoAtualFormatado:P,valorAtualFormatado:I,lucroPrejuizoFormatado:w})})}),l(C=>(console.error("DashboardService: Error fetching quotes for complete patrimony:",C),c(a.map(S=>$(g({},S),{precoAtualFormatado:0}))))))}return c(a)}),l(t=>(console.error("DashboardService: Error fetching complete patrimony for user:",t),c([]))))}),v(1))),this.patrimonioCompletoCache$}getPatrimonioHistorico(o){return this.patrimonioHistoricoCache$||(this.patrimonioHistoricoCache$=this.getUsuarioIdObservable().pipe(F(r=>{if(r==null)return console.error("User ID not available for fetching historical patrimony."),c([]);if(r!==o)return console.warn("User ID mismatch: auth ID does not match requested ID."),c([]);let t=`${this.apiUserPatrimonioPrefix}/${o}/historico`;return b({historico:this.http.get(t).pipe(d(e=>e.map(n=>({idHistorico:n.idHistorico,usuarioId:n.usuarioId,dataRegistro:this.validateDate(n.dataRegistro)??new Date().toISOString(),valorTotal:this.validateNumber(n.valorTotal)??0})).filter(n=>n.dataRegistro!==null&&n.valorTotal!==null)),l(e=>(console.error("DashboardService: Error fetching historical patrimony for user:",e),c([])))),completo:this.getPatrimonioCompleto()}).pipe(d(({historico:e,completo:n})=>!e||e.length===0?(console.warn("No historical data available for user."),[]):e),l(e=>(console.error("DashboardService: Error processing historical patrimony:",e),c([]))),v(1))}))),this.patrimonioHistoricoCache$}getDistribuicaoPatrimonio(){return this.getPatrimonioCompleto().pipe(d(o=>{if(!o||o.length===0)return[];let r={};o.forEach(a=>{let s=a.category||"outros";r[s]=(r[s]||0)+(a.valorAtualFormatado||0)});let t=Object.entries(r).map(([a,s])=>({tipoAtivo:a.charAt(0).toUpperCase()+a.slice(1),valorTotal:s,percentual:0})),e=t.reduce((a,s)=>a+s.valorTotal,0);return t.map(a=>(a.percentual=e>0?a.valorTotal/e*100:0,a.percentual=Math.round(a.percentual*100)/100,a))}),l(o=>(console.error("DashboardService: Error fetching patrimony distribution:",o),c([]))))}getPatrimonioAcoes(){return this.getPatrimonioCompleto().pipe(d(o=>o.filter(r=>r.category==="acoes")),l(o=>(console.error("DashboardService: Error filtering actions from complete patrimony:",o),c([]))))}getPatrimonioFundos(){return this.getPatrimonioCompleto().pipe(d(o=>o.filter(r=>r.category==="fundos")),l(o=>(console.error("DashboardService: Error filtering funds from complete patrimony:",o),c([]))))}getPatrimonioCaixa(){return this.getPatrimonioCompleto().pipe(d(o=>o.filter(r=>r.category==="caixa")),l(o=>(console.error("DashboardService: Error filtering cash from complete patrimony:",o),c([]))))}getPatrimonioAssets(){return this.getPatrimonioCompleto().pipe(d(o=>o.filter(r=>r.category==="assets")),l(o=>(console.error("DashboardService: Error filtering assets from complete patrimony:",o),c([]))))}deleteAtivo(o,r,t){if(!["fundos","acoes","caixa","assets"].includes(t))return console.error(`Invalid category for deletion: ${t}`),p(()=>new Error("Invalid category"));let e=encodeURIComponent(r),n=`${this.apiUserPatrimonioPrefix}/${o}/${e}`;return this.http.delete(n,{observe:"response"}).pipe(h(a=>{a.status===204?(console.log(`Ticker ${r} deleted successfully from category ${t} (204 No Content).`),this.clearPatrimonioCache()):console.warn(`Unexpected response deleting ticker ${r}: status ${a.status}`)}),d(()=>{}),l(a=>(console.error(`Error deleting ticker ${r} from category ${t}:`,a),p(()=>new Error(`Error deleting ticker: ${a.message||"Unknown error"}`)))))}updateAtivo(o,r,t){if(!["fundos","acoes","caixa","assets","outros"].includes(t))return console.error(`Invalid category for update: ${t}`),p(()=>new Error("Invalid category"));if(!r.tickerFormatado||r.tickerFormatado.trim()==="")return console.error(`Invalid ticker for asset in category ${t}:`,r),p(()=>new Error("Invalid ticker"));let e=encodeURIComponent(r.tickerFormatado),n=`${this.apiUserPatrimonioPrefix}/${o}/${e}`,a={idPatrimonio:typeof r.id=="string"?Number(r.id):r.id||0,descricao:r.descricaoFormatada||"",quantidade:r.quantidadeFormatada||0,precoMedio:r.precoMedioFormatado||0,valorInvestido:r.valorInvestidoFormatado||0,ticker:r.tickerFormatado,usuario:{id:Number(o)||0},tipoAtivo:this.mapCategoryToTipoAtivoNumber(t),moeda:r.moeda||"BRL"};if(a.tipoAtivo===3){let s=typeof r.valorAtualFormatado=="string"?parseFloat(r.valorAtualFormatado.replace(",","."))||0:typeof r.valorAtualFormatado=="number"?r.valorAtualFormatado:0;s>0&&(a.valorAtual=s)}return this.http.put(n,a,{headers:{"Content-Type":"application/json"}}).pipe(h(()=>{console.log(`Asset with ticker ${r.tickerFormatado} updated successfully in category ${t}.`),this.clearPatrimonioCache()}),l(s=>(console.error(`Error updating asset with ticker ${r.tickerFormatado} in category ${t}:`,s),p(()=>new Error(`Error updating asset: ${s.message||"Unknown error"}`)))))}addTransaction(o,r){let t=r.category;return["fundos","acoes","assets","caixa"].includes(t)?(this.clearPatrimonioCache(),c({success:!0})):(console.error(`Invalid category for transaction: ${t}`),p(()=>new Error("Invalid category")))}clearPatrimonioCache(){this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null,this.patrimonioHistoricoCache$=null,console.log("DashboardService: Patrimony and historical cache cleared.")}mapTipoAtivoToCategory(o){switch(o.toUpperCase()){case"A\xC7\xC3O":return"acoes";case"FII":case"FUNDO":return"fundos";case"CAIXA":return"caixa";case"ASSET":return"assets";default:return"outros"}}mapCategoryToTipoAtivoNumber(o){switch(o.toLowerCase()){case"acoes":return 1;case"fundos":return 2;case"caixa":return 3;case"assets":return 4;default:return 0}}validateDate(o){if(!o){console.warn(`Invalid date: ${o}`);return}let r=/^(\d{2})\/(\d{2})\/(\d{4})$/,t=o.match(r);if(t){let n=parseInt(t[1],10),a=parseInt(t[2],10)-1,s=parseInt(t[3],10),i=new Date(s,a,n);if(!isNaN(i.getTime())&&i.getDate()===n&&i.getMonth()===a&&i.getFullYear()===s)return o;console.warn(`Invalid date values: ${o}`);return}let e=new Date(o);if(!isNaN(e.getTime()))return o;console.warn(`Invalid date format: ${o}`)}validateNumber(o){let r=parseFloat(o);if(isNaN(r)){console.warn(`Invalid number format: ${o}`);return}return r}static{this.\u0275fac=function(r){return new(r||m)}}static{this.\u0275prov=D({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();export{N as a,O as b};
