import{c as A,mc as N,oc as w}from"./chunk-DSE3UXWR.js";import{D as d,H as D,T as S,W as C,Z as p,aa as T,ga as P,m as c,n as f,q as u,w as $}from"./chunk-ZCYO3KUH.js";import{a as F,b as I}from"./chunk-4X36HX5K.js";var x={production:!0,baseUrl:"https://apis.dividendosparatodos.com.br/services/",authUrl:"https://apis.dividendosparatodos.com.br/services/",useHash:!1};var q=(()=>{class g{constructor(){this.http=P(A),this.authService=P(w),this.store=P(N),this.apiUserPatrimonioPrefix="/api/patrimonios/usuario",this.apiCotacoesPrefix="/api/cotacoes/tickers",this.apiTransacoesPrefix="/api/transacoes/lote",this.PATRIMONIO_COMPLETO_KEY="patrimonioCompletoCache",this.PATRIMONIO_HISTORICO_KEY="patrimonioHistoricoCache",this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null,this.patrimonioHistoricoCache$=null,this.apiUrl="/api"}getUsuarioIdObservable(){return this.authService.user().pipe(D(1),u(o=>o?.id))}createTransactionLote(o,r){let t=`${this.apiTransacoesPrefix}/${o}`;return this.http.post(t,r).pipe(p(()=>this.clearPatrimonioCache()))}createTransaction(o,r){let t=`${this.apiUrl}/transacoes/${o}/criarTransacao`;return this.http.post(t,r).pipe(p(()=>this.clearPatrimonioCache()))}getCotacaoUSD(){if(!this.cotacaoUSDCache$){let o=`${this.apiCotacoesPrefix}?tickers=USD/BRL`;this.cotacaoUSDCache$=this.http.get(o).pipe(u(r=>{if(!r||r.length===0)return console.warn("DashboardService: Empty or null USD quote response. Returning 0."),0;let t=r[0].valorCotacao;return typeof t!="number"||isNaN(t)||t<=0?(console.warn("DashboardService: Invalid 'valorCotacao' in response. Returning 0.",r[0]),0):t}),d(r=>(console.error("DashboardService: HTTP error fetching USD quote. Returning 0.",r),c(0))),S(1))}return this.cotacaoUSDCache$}parseFormattedString(o){if(o==null)return 0;if(typeof o=="number")return o;if(o.trim()==="")return 0;let r=o.trim();r=r.replace(/[^\d.,-]/g,""),r.includes(",")&&r.includes(".")?r.indexOf(",")>r.indexOf(".")?(r=r.replace(/\./g,""),r=r.replace(/,/g,".")):r=r.replace(/,/g,""):r.includes(",")&&(r=r.replace(/,/g,"."));let t=parseFloat(r);return isNaN(t)?(console.warn(`[DashboardService.parseFormattedString] Failed to parse: "${o}" -> "${r}". Returning 0.`),0):t}convertUsdToBrlNumeric(o,r){return r<=0?(console.warn(`[convertUsdToBrlNumeric] Invalid or zero USD quote (${r}). Returning assets without numeric conversion.`),o):o.map(t=>{let e=F({},t);if(e.moedaFormatada==="USD"){let s=this.parseFormattedString(e.valorAtualFormatado?.toString());e.valorAtualFormatado=isNaN(s)?0:s*r;let a=this.parseFormattedString(e.valorInvestidoFormatado?.toString());e.valorInvestidoFormatado=isNaN(a)?0:a*r;let n=this.parseFormattedString(e.precoMedioFormatado?.toString());e.precoMedioFormatado=isNaN(n)?0:n*r,e.lucroPrejuizoFormatado=e.valorAtualFormatado-e.valorInvestidoFormatado,e.moedaFormatada="BRL"}else e.valorAtualFormatado=this.parseFormattedString(e.valorAtualFormatado?.toString()),e.valorInvestidoFormatado=this.parseFormattedString(e.valorInvestidoFormatado?.toString()),e.precoMedioFormatado=this.parseFormattedString(e.precoMedioFormatado?.toString()),e.lucroPrejuizoFormatado=this.parseFormattedString(e.lucroPrejuizoFormatado?.toString());return e.quantidadeFormatada=this.parseFormattedString(e.quantidadeFormatada?.toString()),e})}getPatrimonioCompleto(){return this.patrimonioCompletoCache$||(this.patrimonioCompletoCache$=this.getUsuarioIdObservable().pipe(C(o=>{if(o==null)return console.error("User ID not available for fetching complete patrimony."),c([]);let r=`${this.apiUserPatrimonioPrefix}/${o}`;return $({patrimonio:this.http.get(r).pipe(p(t=>console.log("Raw API Response:",t))),cotacao:this.getCotacaoUSD()}).pipe(C(({patrimonio:t,cotacao:e})=>{if(!t||t.length===0)return c([]);let s=t.map(i=>{let m=this.parseFormattedString(i.quantidade||i.quantidadeFormatada),h=this.parseFormattedString(i.precoMedio||i.precoMedioFormatado),l=this.parseFormattedString(i.valorInvestido||i.valorInvestidoFormatado);return l===0&&m>0&&h>0&&(l=m*h),{id:i.idPatrimonio||i.id||0,tickerFormatado:i.ticker||i.tickerFormatado||"",descricaoFormatada:i.descricao||i.descricaoFormatada||"",tipoAtivoFormatado:i.tipoAtivoFormatado||"",moedaFormatada:i.moeda||i.moedaFormatada||"BRL",quantidadeFormatada:m,valorInvestidoFormatado:l,precoMedioFormatado:h,precoAtualFormatado:0,valorAtualFormatado:this.parseFormattedString(i.valorAtual||i.valorAtualFormatado),lucroPrejuizoFormatado:this.parseFormattedString(i.lucroPrejuizo||i.lucroPrejuizoFormatado),moeda:i.moeda||"BRL",category:this.mapTipoAtivoToCategory(i.tipoAtivo,i.tipoAtivoFormatado)}});console.log("Processed AtivosVO:",s);let a=this.convertUsdToBrlNumeric(s,e),n=a.filter(i=>i.category!=="caixa"&&i.tickerFormatado).map(i=>i.tickerFormatado);if(n.length>0){let i=`${this.apiCotacoesPrefix}?tickers=${n.join(",")}`;return this.http.get(i).pipe(u(m=>{let h=new Map(m.map(l=>[l.ticker,{valorCotacao:l.valorCotacao,cambio:l.cambio}]));return a.map(l=>{if(l.category==="caixa")return l;let v=h.get(l.tickerFormatado),b=v?v.cambio==="USD"?v.valorCotacao*e:v.valorCotacao:0,y=l.quantidadeFormatada*b,U=y-l.valorInvestidoFormatado;return I(F({},l),{precoAtualFormatado:b,valorAtualFormatado:y,lucroPrejuizoFormatado:U})})}),d(m=>(console.error("DashboardService: Error fetching quotes for complete patrimony:",m),c(a.map(h=>I(F({},h),{precoAtualFormatado:0}))))))}return c(a)}),p(t=>this.store.set(this.PATRIMONIO_COMPLETO_KEY,t)),d(t=>(console.error("DashboardService: Error fetching complete patrimony for user:",t),c([]))))}),S(1))),this.patrimonioCompletoCache$}getPatrimonioHistorico(o){return this.patrimonioHistoricoCache$||(this.patrimonioHistoricoCache$=this.getUsuarioIdObservable().pipe(C(r=>{if(r==null)return console.error("User ID not available for fetching historical patrimony."),c([]);if(r!==o)return console.warn("User ID mismatch: auth ID does not match requested ID."),c([]);let t=`${this.apiUserPatrimonioPrefix}/${o}/historico`;return $({historico:this.http.get(t).pipe(u(e=>e.map(s=>({idHistorico:s.idHistorico,usuarioId:s.usuarioId,dataRegistro:this.validateDate(s.dataRegistro)??new Date().toISOString(),valorTotal:this.validateNumber(s.valorTotal)??0})).filter(s=>s.dataRegistro!==null&&s.valorTotal!==null)),d(e=>(console.error("DashboardService: Error fetching historical patrimony for user:",e),c([])))),completo:this.getPatrimonioCompleto()}).pipe(u(({historico:e,completo:s})=>!e||e.length===0?(console.warn("No historical data available for user."),[]):e),p(e=>this.store.set(this.PATRIMONIO_HISTORICO_KEY,e)),d(e=>(console.error("DashboardService: Error processing historical patrimony:",e),c([]))),S(1))}))),this.patrimonioHistoricoCache$}getDistribuicaoPatrimonio(){return this.getPatrimonioCompleto().pipe(u(o=>this.calculateDistribuicao(o)),d(o=>(console.error("DashboardService: Error fetching patrimony distribution:",o),c([]))))}calculateDistribuicao(o){if(!o||o.length===0)return[];let r={};o.forEach(a=>{let n=a.category||"outros";r[n]=(r[n]||0)+(a.valorAtualFormatado||0)});let t=Object.entries(r).map(([a,n])=>({tipoAtivo:a.charAt(0).toUpperCase()+a.slice(1),valorTotal:n,percentual:0})),e=t.reduce((a,n)=>a+n.valorTotal,0);return t.map(a=>(a.percentual=e>0?a.valorTotal/e*100:0,a.percentual=Math.round(a.percentual*100)/100,a))}getPatrimonioAcoes(){return this.getPatrimonioCompleto().pipe(u(o=>o.filter(r=>r.category==="acoes")),d(o=>(console.error("DashboardService: Error filtering actions from complete patrimony:",o),c([]))))}getPatrimonioFundos(){return this.getPatrimonioCompleto().pipe(u(o=>o.filter(r=>r.category==="fundos")),d(o=>(console.error("DashboardService: Error filtering funds from complete patrimony:",o),c([]))))}getPatrimonioCaixa(){return this.getPatrimonioCompleto().pipe(u(o=>o.filter(r=>r.category==="caixa")),d(o=>(console.error("DashboardService: Error filtering cash from complete patrimony:",o),c([]))))}getPatrimonioAssets(){return this.getPatrimonioCompleto().pipe(u(o=>o.filter(r=>r.category==="assets")),d(o=>(console.error("DashboardService: Error filtering assets from complete patrimony:",o),c([]))))}getStoredPatrimonioCompleto(){let o=this.store.get(this.PATRIMONIO_COMPLETO_KEY);return Array.isArray(o)?o:[]}getStoredPatrimonioHistorico(){let o=this.store.get(this.PATRIMONIO_HISTORICO_KEY);return Array.isArray(o)?o:[]}getStoredDistribuicaoPatrimonio(){let o=this.getStoredPatrimonioCompleto();return this.calculateDistribuicao(o)}getStoredPatrimonioAcoes(){return this.getStoredPatrimonioCompleto().filter(r=>r.category==="acoes")}getStoredPatrimonioFundos(){return this.getStoredPatrimonioCompleto().filter(r=>r.category==="fundos")}getStoredPatrimonioCaixa(){return this.getStoredPatrimonioCompleto().filter(r=>r.category==="caixa")}getStoredPatrimonioAssets(){return this.getStoredPatrimonioCompleto().filter(r=>r.category==="assets")}deleteAtivo(o,r,t){if(!["fundos","acoes","caixa","assets"].includes(t))return console.error(`Invalid category for deletion: ${t}`),f(()=>new Error("Invalid category"));let e=encodeURIComponent(r),s=`${this.apiUserPatrimonioPrefix}/${o}/${e}`;return this.http.delete(s,{observe:"response"}).pipe(p(a=>{a.status===204?(console.log(`Ticker ${r} deleted successfully from category ${t} (204 No Content).`),this.clearPatrimonioCache()):console.warn(`Unexpected response deleting ticker ${r}: status ${a.status}`)}),u(()=>{}),d(a=>(console.error(`Error deleting ticker ${r} from category ${t}:`,a),f(()=>new Error(`Error deleting ticker: ${a.message||"Unknown error"}`)))))}updateAtivo(o,r,t){if(!["fundos","acoes","caixa","assets","outros"].includes(t))return console.error(`Invalid category for update: ${t}`),f(()=>new Error("Invalid category"));if(!r.tickerFormatado||r.tickerFormatado.trim()==="")return console.error(`Invalid ticker for asset in category ${t}:`,r),f(()=>new Error("Invalid ticker"));let e=encodeURIComponent(r.tickerFormatado),s=`${this.apiUserPatrimonioPrefix}/${o}/${e}`,a={idPatrimonio:typeof r.id=="string"?Number(r.id):r.id||0,descricao:r.descricaoFormatada||"",quantidade:r.quantidadeFormatada||0,precoMedio:r.precoMedioFormatado||0,valorInvestido:r.valorInvestidoFormatado||0,ticker:r.tickerFormatado,usuario:{id:Number(o)||0},tipoAtivo:this.mapCategoryToTipoAtivoNumber(t),moeda:r.moeda||"BRL"};if(a.tipoAtivo===3){let n=typeof r.valorAtualFormatado=="string"?parseFloat(r.valorAtualFormatado.replace(",","."))||0:typeof r.valorAtualFormatado=="number"?r.valorAtualFormatado:0;n>0&&(a.valorAtual=n)}return this.http.put(s,a,{headers:{"Content-Type":"application/json"}}).pipe(p(()=>{console.log(`Asset with ticker ${r.tickerFormatado} updated successfully in category ${t}.`),this.clearPatrimonioCache()}),d(n=>(console.error(`Error updating asset with ticker ${r.tickerFormatado} in category ${t}:`,n),f(()=>new Error(`Error updating asset: ${n.message||"Unknown error"}`)))))}addTransaction(o,r){let t=r.category;return["fundos","acoes","assets","caixa"].includes(t)?(this.clearPatrimonioCache(),c({success:!0})):(console.error(`Invalid category for transaction: ${t}`),f(()=>new Error("Invalid category")))}clearPatrimonioCache(){this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null,this.patrimonioHistoricoCache$=null,console.log("DashboardService: Patrimony and historical cache cleared.")}mapTipoAtivoToCategory(o,r){if(o==null)return r&&r.toLowerCase().includes("caixa")?"caixa":"outros";if(typeof o=="number"||!isNaN(Number(o))&&!isNaN(parseFloat(o)))switch(Number(o)){case 1:return"acoes";case 2:return"fundos";case 3:return"caixa";case 4:return"assets";default:return r&&r.toLowerCase().includes("caixa")?"caixa":"outros"}if(typeof o=="string")switch(o.toUpperCase()){case"A\xC7\xC3O":case"A\xC7\xD5ES":return"acoes";case"FII":case"FUNDO":case"FUNDOS":return"fundos";case"CAIXA":return"caixa";case"ASSET":case"ASSETS":return"assets";default:return r&&r.toLowerCase().includes("caixa")?"caixa":"outros"}return r&&r.toLowerCase().includes("caixa")?"caixa":"outros"}mapCategoryToTipoAtivoNumber(o){switch(o.toLowerCase()){case"acoes":return 1;case"fundos":return 2;case"caixa":return 3;case"assets":return 4;default:return 0}}formatDateToDDMMYYYY(o){let r=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0"),e=o.getFullYear();return`${r}/${t}/${e}`}validateDate(o){if(!o){console.warn(`Invalid date: ${o}`);return}let r=/^(\d{2})\/(\d{2})\/(\d{4})$/,t=o.match(r);if(t){let s=parseInt(t[1],10),a=parseInt(t[2],10)-1,n=parseInt(t[3],10),i=new Date(n,a,s);if(!isNaN(i.getTime())&&i.getDate()===s&&i.getMonth()===a&&i.getFullYear()===n)return o;console.warn(`Invalid date values: ${o}`);return}let e=new Date(o);if(!isNaN(e.getTime()))return this.formatDateToDDMMYYYY(e);console.warn(`Invalid date format: ${o}`)}validateNumber(o){let r=parseFloat(o);if(isNaN(r)){console.warn(`Invalid number format: ${o}`);return}return r}static{this.\u0275fac=function(r){return new(r||g)}}static{this.\u0275prov=T({token:g,factory:g.\u0275fac,providedIn:"root"})}}return g})();export{x as a,q as b};
