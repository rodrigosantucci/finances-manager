import{Jc as x,b as E}from"./chunk-HNAS5IHB.js";import{$ as C,D as T,K as c,P as U,a as v,b as f,ca as S,fa as b,ia as k,oa as $,t as n,u as p,x as u}from"./chunk-PGMU4RYJ.js";var N={production:!0,baseUrl:"https://apis.dividendosparatodos.com.br/services/",authUrl:"https://apis.dividendosparatodos.com.br/services/",useHash:!1};var q=(()=>{class m{constructor(){this.http=$(E),this.authService=$(x),this.apiUserPatrimonioPrefix="/api/patrimonios/usuario/",this.apiCotacoesPrefix="/api/cotacoes/tickers/",this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null}getUsuarioIdObservable(){return this.authService.user().pipe(U(1),u(r=>r?.id))}getCotacaoUSD(){if(!this.cotacaoUSDCache$){let r=`${this.apiCotacoesPrefix}?tickers=USD/BRL`;this.cotacaoUSDCache$=this.http.get(r).pipe(u(o=>{if(!o||o.length===0)return console.warn("DashboardService: Resposta da API de cota\xE7\xE3o veio vazia ou nula para USD. Retornando 0."),0;let t=o[0].valorCotacao;return typeof t!="number"||isNaN(t)||t<=0?(console.warn("DashboardService: A propriedade 'valorCotacao' \xE9 inv\xE1lida no primeiro item da resposta. Retornando 0.",o[0]),0):t}),c(o=>(console.error("DashboardService: Erro HTTP ao buscar cota\xE7\xE3o USD. Retornando 0.",o),n(0))),C(1))}return this.cotacaoUSDCache$}parseFormattedString(r){if(r==null||r.trim()==="")return 0;let o=r.trim();o=o.replace(/[^\d.,-]/g,""),o.includes(",")&&o.includes(".")?o.indexOf(",")>o.indexOf(".")?(o=o.replace(/\./g,""),o=o.replace(/,/g,".")):o=o.replace(/,/g,""):o.includes(",")&&(o=o.replace(/,/g,"."));let t=parseFloat(o);return isNaN(t)?(console.warn(`[DashboardService.parseFormattedString] Falha ao parsear: "${r}" -> "${o}". Retornando 0.`),0):t}convertUsdToBrlNumeric(r,o){return o<=0?(console.warn(`[convertUsdToBrlNumeric] Cota\xE7\xE3o USD inv\xE1lida ou zero (${o}). Retornando ativos sem convers\xE3o num\xE9rica.`),r):r.map(t=>{let a=v({},t);if(a.moedaFormatada==="USD"){let d=this.parseFormattedString(a.valorAtualFormatado?.toString());isNaN(d)?a.valorAtualFormatado=0:a.valorAtualFormatado=d*o;let e=this.parseFormattedString(a.valorInvestidoFormatado?.toString());isNaN(e)?a.valorInvestidoFormatado=0:a.valorInvestidoFormatado=e*o;let i=this.parseFormattedString(a.precoMedioFormatado?.toString());isNaN(i)?a.precoMedioFormatado=0:a.precoMedioFormatado=i*o,a.lucroPrejuizoFormatado=a.valorAtualFormatado-a.valorInvestidoFormatado,a.moedaFormatada="BRL"}else a.valorAtualFormatado=this.parseFormattedString(a.valorAtualFormatado?.toString()),a.valorInvestidoFormatado=this.parseFormattedString(a.valorInvestidoFormatado?.toString()),a.precoMedioFormatado=this.parseFormattedString(a.precoMedioFormatado?.toString()),a.lucroPrejuizoFormatado=this.parseFormattedString(a.lucroPrejuizoFormatado?.toString());return a.quantidadeFormatada=this.parseFormattedString(a.quantidadeFormatada?.toString()),a})}getPatrimonioCompleto(){return this.patrimonioCompletoCache$||(this.patrimonioCompletoCache$=this.getUsuarioIdObservable().pipe(S(r=>{if(r==null)return console.error("ID do usu\xE1rio n\xE3o dispon\xEDvel para buscar patrim\xF4nio completo."),n([]);let o=`${this.apiUserPatrimonioPrefix}${r}/patrimoniocompleto`;return T({patrimonio:this.http.get(o),cotacao:this.getCotacaoUSD()}).pipe(S(({patrimonio:t,cotacao:a})=>{if(!t||t.length===0)return n([]);let d=t.map(s=>({id:s.ticker,tickerFormatado:s.tickerFormatado,descricaoFormatada:s.descricaoFormatada,tipoAtivoFormatado:s.tipoAtivoFormatado,moedaFormatada:s.moedaFormatada,quantidadeFormatada:this.parseFormattedString(s.quantidadeFormatada),valorInvestidoFormatado:this.parseFormattedString(s.valorInvestidoFormatado),precoMedioFormatado:this.parseFormattedString(s.precoMedioFormatado),precoAtualFormatado:0,valorAtualFormatado:this.parseFormattedString(s.valorAtualFormatado),lucroPrejuizoFormatado:this.parseFormattedString(s.lucroPrejuizoFormatado),moeda:s.moeda,category:this.mapTipoAtivoToCategory(s.tipoAtivoFormatado)})),e=this.convertUsdToBrlNumeric(d,a),i=e.filter(s=>s.tipoAtivoFormatado!=="CAIXA").map(s=>s.tickerFormatado);if(i.length>0){let s=`${this.apiCotacoesPrefix}?tickers=${i.join(",")}`;return this.http.get(s).pipe(u(F=>{let g=new Map(F.map(l=>[l.ticker,{valorCotacao:l.valorCotacao,cambio:l.cambio}]));return e.map(l=>{if(l.tipoAtivoFormatado==="CAIXA")return l;let h=g.get(l.tickerFormatado),A=h?h.cambio==="USD"?h.valorCotacao*a:h.valorCotacao:0,P=l.quantidadeFormatada*A,D=P-l.valorInvestidoFormatado;return f(v({},l),{precoAtualFormatado:A,valorAtualFormatado:P,lucroPrejuizoFormatado:D})})}),c(F=>(console.error("DashboardService: Erro ao buscar cota\xE7\xF5es para o patrim\xF4nio completo:",F),n(e.map(g=>f(v({},g),{precoAtualFormatado:0}))))))}else return n(e)}),c(t=>(console.error(`DashboardService: Erro ao buscar patrim\xF4nio completo para usu\xE1rio ${r}:`,t),n([]))))}),C(1))),this.patrimonioCompletoCache$}getDistribuicaoPatrimonio(){return this.getPatrimonioCompleto().pipe(u(r=>{if(!r||r.length===0)return[];let o={};r.forEach(e=>{let i=e.category||"outros";o[i]=(o[i]||0)+(e.valorAtualFormatado||0)});let t=Object.entries(o).map(([e,i])=>({tipoAtivo:e.charAt(0).toUpperCase()+e.slice(1),valorTotal:i,percentual:0})),a=t.reduce((e,i)=>e+i.valorTotal,0);return t.map(e=>(e.percentual=a>0?e.valorTotal/a*100:0,e.percentual=Math.round(e.percentual*100)/100,e))}),c(r=>(console.error("DashboardService: Erro ao buscar distribui\xE7\xE3o de patrim\xF4nio:",r),n([]))))}getPatrimonioAcoes(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="acoes")),c(r=>(console.error("DashboardService: Erro ao filtrar a\xE7\xF5es do patrim\xF4nio completo:",r),n([]))))}getPatrimonioFundos(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="fundos")),c(r=>(console.error("DashboardService: Erro ao filtrar fundos do patrim\xF4nio completo:",r),n([]))))}getPatrimonioCaixa(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="caixa")),c(r=>(console.error("DashboardService: Erro ao filtrar caixa do patrim\xF4nio completo:",r),n([]))))}getPatrimonioAssets(){return this.getPatrimonioCompleto().pipe(u(r=>r.filter(o=>o.category==="assets")),c(r=>(console.error("DashboardService: Erro ao filtrar assets do patrim\xF4nio completo:",r),n([]))))}deleteAtivo(r,o,t){if(!["fundos","acoes","caixa","assets"].includes(t))return console.error(`Categoria inv\xE1lida para exclus\xE3o: ${t}`),p(()=>new Error("Categoria inv\xE1lida"));let a=encodeURIComponent(o),d=`${this.apiUserPatrimonioPrefix}${r}/${a}`;return this.http.delete(d,{observe:"response"}).pipe(b(e=>{e.status===204?(console.log(`Ticker ${o} exclu\xEDdo com sucesso da categoria ${t} (204 No Content).`),this.patrimonioCompletoCache$=null):console.warn(`Resposta inesperada ao excluir Ticker ${o}: status ${e.status}`)}),u(()=>{}),c(e=>(console.error(`Erro ao excluir Ticker ${o} da categoria ${t}:`,e),p(()=>new Error(`Erro ao excluir Ticker: ${e.message||"Erro desconhecido"}`)))))}updateAtivo(r,o,t){if(!["fundos","acoes","caixa","assets","outros"].includes(t))return console.error(`Categoria inv\xE1lida para atualiza\xE7\xE3o: ${t}`),p(()=>new Error("Categoria inv\xE1lida"));if(!o.tickerFormatado||o.tickerFormatado.trim()==="")return console.error(`Ticker inv\xE1lido para ativo na categoria ${t}:`,o),p(()=>new Error("Ticker inv\xE1lido"));let a=encodeURIComponent(o.tickerFormatado),d=`${this.apiUserPatrimonioPrefix}${r}/${a}`;console.log("URL de atualiza\xE7\xE3o gerada:",d);let e={idPatrimonio:typeof o.id=="string"?Number(o.id):o.id||0,descricao:o.descricaoFormatada||"",quantidade:o.quantidadeFormatada,precoMedio:o.precoMedioFormatado,valorInvestido:o.valorInvestidoFormatado,ticker:o.tickerFormatado,usuario:{id:Number(r)||0},tipoAtivo:this.mapCategoryToTipoAtivoNumber(t),moeda:o.moeda};return console.log("Objeto enviado para atualiza\xE7\xE3o:",e),this.http.put(d,e,{headers:{"Content-Type":"application/json"}}).pipe(b(()=>{console.log(`Ativo com ticker ${o.tickerFormatado} atualizado com sucesso na categoria ${t}.`),this.patrimonioCompletoCache$=null}),c(i=>{console.error(`Erro ao atualizar ativo com ticker ${o.tickerFormatado} na categoria ${t}:`,{status:i.status,statusText:i.statusText,error:i.error,requestBody:e});let s=i.error?.attributeName&&i.error?.objectName?`Erro de valida\xE7\xE3o no campo '${i.error.attributeName}' para o objeto '${i.error.objectName}'. Valor inv\xE1lido: '${i.error.value}'`:i.error?.message||i.message||"Erro desconhecido";return p(()=>new Error(`Erro ao atualizar ativo: ${s}`))}))}addTransaction(r,o){let t=o.category;return["fundos","acoes","assets","caixa"].includes(t)?(this.patrimonioCompletoCache$=null,n({success:!0})):(console.error(`Categoria inv\xE1lida para transa\xE7\xE3o: ${t}`),p(()=>new Error("Categoria inv\xE1lida")))}clearPatrimonioCache(){this.patrimonioCompletoCache$=null,this.cotacaoUSDCache$=null}mapTipoAtivoToCategory(r){switch(r.toUpperCase()){case"A\xC7\xC3O":return"acoes";case"FII":case"FUNDO":return"fundos";case"CAIXA":return"caixa";case"ASSET":return"assets";default:return"outros"}}mapCategoryToTipoAtivoNumber(r){switch(r.toLowerCase()){case"acoes":return 1;case"fundos":return 2;case"caixa":return 3;case"assets":return 4;default:return 0}}static{this.\u0275fac=function(o){return new(o||m)}}static{this.\u0275prov=k({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})();export{N as a,q as b};
